---

# This batch scenario will give you a Cloud 8 deployment suitable for
# performing a disruptive (normal) upgrade to Cloud 9. You can apply it to a cloud
# with Crowbar already installed (no OpenStack barclamps applied, yet).
#
# Before you apply this batch scenario, you will need to make a few
# preparations:
#
# 1. Ensure the following aliases exist in Crowbar and point to nodes
#    suitable as controllers and compute nodes, respectively:
#
#    * controller1
#    * controller2
#    * controller3
#    * compute1
#    * compute2
#    * compute3
#
# 2. Provide two NFS shares (one for Glance, one for Cinder) that all
#    controllers and compute nodes have read and write acccess to. These should
#    not be exported by any cloud node (including the Crowbar node) since all
#    nodes will be rebooted in the course of the upgrade. Then substitute these
#    NFS shares' host names/paths for the following placeholders in this scenario file:
#
#    * ##shared_nfs_for_glance##            Host name only.
#    * ##shared_nfs_export_for_glance##     Path only.
#    * ##cinder-storage-shares##            Use a <hostname>:<path> combination for this.
#
# Once you have made these preparations, copy this scenario file to your
# Crowbar node's /root directory and apply it using the follow command:
#
#    crowbar batch --timeout 3600 build /root/scenario-nondisruptive.yaml

proposals:
- barclamp: nfs_client
  name: glance
  attributes:
    exports:
      glance:
        nfs_server: ##shared_nfs_for_glance##
        export: ##shared_nfs_export_for_glance##
        mount_path: "/images"
  deployment:
    elements:
      nfs-client:
      - "@@controller1@@"
      - "@@controller2@@"
      - "@@controller3@@"

- barclamp: pacemaker
  name: services
  attributes:
    stonith:
      mode: ipmi_barclamp
      sbd:
        nodes:
          @@controller1@@:
            devices:
            - ''
          @@controller2@@:
            devices:
            - ''
          @@controller3@@:
            devices:
            - ''
      per_node:
        nodes:
          @@controller1@@:
            params: ''
          @@controller2@@:
            params: ''
          @@controller3@@:
            params: ''
    drbd:
  deployment:
    elements:
      pacemaker-cluster-member:
      - "@@controller1@@"
      - "@@controller2@@"
      - "@@controller3@@"
      hawk-server:
      - "@@controller1@@"
      - "@@controller2@@"
      - "@@controller3@@"

- barclamp: database
  deployment:
    elements:
      database-server:
      - cluster:services

- barclamp: rabbitmq
  attributes:
    client:
      enable_notifications: true
  deployment:
    elements:
      rabbitmq-server:
      - cluster:services

- barclamp: keystone
  attributes:
  deployment:
    elements:
      keystone-server:
      - cluster:services

- barclamp: glance
  attributes:
  deployment:
    elements:
      glance-server:
      - cluster:services

- barclamp: cinder
  attributes:
    volumes:
    - backend_driver: nfs
      backend_name: nfs
      nfs:
        nfs_shares: ##cinder-storage-shares##
        nfs_snapshot: true
  deployment:
    elements:
      cinder-controller:
      - cluster:services
      cinder-volume:
      - cluster:services

- barclamp: neutron
  attributes:
    ml2_mechanism_drivers:
    - 'openvswitch'
    ml2_type_drivers:
    - 'vlan'
    num_vlans: 99
    ml2_type_drivers_default_provider_network: 'vlan'
    ml2_type_drivers_default_tenant_network: 'vlan'
  deployment:
    elements:
      neutron-server:
      - cluster:services
      neutron-network:
      - cluster:services

- barclamp: nova
  attributes:
    itxt_instance: ''
    use_migration: true
    vnc_keymap: de
    kvm:
      ksm_enabled: true
    metadata:
      vendordata:
        json: '{"custom-key": "custom-value"}'
  deployment:
    elements:
      ec2-api:
      - cluster:services
      nova-controller:
      - cluster:services
      nova-compute-hyperv: []
      nova-compute:
      - "@@compute1@@"
      - "@@compute2@@"
      - "@@compute3@@"
      nova-compute-qemu: []
      nova-compute-xen: []

- barclamp: horizon
  attributes:
  deployment:
    elements:
      horizon-server:
      - cluster:services

- barclamp: heat
  attributes:
  deployment:
    elements:
      heat-server:
      - cluster:services

- barclamp: tempest
  attributes:
  deployment:
    elements:
      tempest:
      - "@@controller1@@"
